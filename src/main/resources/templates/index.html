<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --gold-primary: #FFD700;
            --dark-bg: #1a1a1a;
            --card-bg: #2c2c2c;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #444;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .summary-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }

        .summary-card h5 {
            color: var(--text-secondary);
        }

        .summary-card .amount {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }
        
        .card-header {
            background-color: var(--dark-bg);
            color: var(--gold-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .currency-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }
        .expense-icon { background-color: var(--danger-color); }
        .income-icon { background-color: var(--success-color); }


        .form-control, .form-select {
            background-color: #3d3d3d;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus {
            background-color: #3d3d3d;
            border-color: var(--gold-primary);
            box-shadow: none;
            color: var(--text-primary);
        }
        
        .form-label {
            color: #E5E4E2;
        }

        .table {
            color: var(--text-primary);
        }

        .table > thead {
            color: var(--gold-primary);
        }
        
        .btn-gold {
            background-color: var(--gold-primary);
            color: var(--dark-bg);
            font-weight: bold;
            border: 1px solid var(--gold-primary);
        }
        .btn-gold:hover {
            background-color: #ffeb80;
            color: #000;
            border: 1px solid #ffeb80;
        }
        
        .modal-content {
             background-color: var(--card-bg);
             border: 1px solid var(--border-color);
        }
        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }
        .modal-footer {
            border-top: 1px solid var(--border-color);
        }
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" style="color: var(--gold-primary);" href="#">ðŸ’° Expense Tracker</a>
            <div class="d-flex align-items-center">
                <span class="navbar-text me-3">
                    Welcome, <strong sec:authentication="name">Username</strong>
                </span>
                <a th:href="@{/export/excel}" class="btn btn-sm btn-outline-warning me-2">
                    <i class="fas fa-file-excel"></i> Export Excel
                </a>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button class="btn btn-sm btn-outline-light" type="submit">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="row g-4 mb-4 text-center">
            <div class="col-md-4">
                <div class="summary-card">
                    <h5>Total Income</h5>
                    <p class="amount" style="color: var(--success-color);" th:text="'â‚¹' + ${#numbers.formatDecimal(totalIncome, 1, 'COMMA', 2, 'POINT')}">â‚¹0.00</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card">
                    <h5>Total Expenses</h5>
                    <p class="amount" style="color: var(--danger-color);" th:text="'â‚¹' + ${#numbers.formatDecimal(totalExpenses, 1, 'COMMA', 2, 'POINT')}">â‚¹0.00</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card">
                    <h5>Balance</h5>
                    <p class="amount" th:text="'â‚¹' + ${#numbers.formatDecimal(balance, 1, 'COMMA', 2, 'POINT')}">â‚¹0.00</p>
                </div>
            </div>
        </div>

        
        <div class="row g-4 mb-4">
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="currency-icon expense-icon">â‚¹</div>
                        <h5>Add Expense</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/addExpense}" th:object="${newExpense}" method="post">
                             <div class="mb-3">
                                <label for="expense-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="expense-date" th:field="*{expense_date}" required>
                            </div>
                            <div class="mb-3">
                                <label for="expense-amount" class="form-label">Amount (â‚¹)</label>
                                <input type="number" step="0.01" class="form-control" id="expense-amount" th:field="*{amount}" required>
                            </div>
                             <div class="mb-3">
                                <label for="expense-category" class="form-label">Category</label>
                                <select class="form-select" id="expense-category" th:field="*{category}" required>
                                    <option value="Food">Food</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Rent">Rent</option>
                                    <option value="Groceries">Groceries</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Health">Health</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="expense-desc" class="form-label">Description</label>
                                <input type="text" class="form-control" id="expense-desc" th:field="*{description}" placeholder="Optional">
                            </div>
                            <button type="submit" class="btn btn-danger">Add Expense</button>
                        </form>
                    </div>
                </div>
            </div>

           
            <div class="col-md-6">
                 <div class="card h-100">
                    <div class="card-header">
                        <div class="currency-icon income-icon">â‚¹</div>
                        <h5>Add Income</h5>
                    </div>
                    <div class="card-body">
                         <form th:action="@{/addIncome}" th:object="${newIncome}" method="post">
                             <div class="mb-3">
                                <label for="income-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="income-date" th:field="*{expense_date}" required>
                            </div>
                            <div class="mb-3">
                                <label for="income-amount" class="form-label">Amount (â‚¹)</label>
                                <input type="number" step="0.01" class="form-control" id="income-amount" th:field="*{amount}" required>
                            </div>
                            <div class="mb-3">
                                <label for="income-category" class="form-label">Category</label>
                                <select class="form-select" id="income-category" th:field="*{category}" required>
                                    <option value="Salary">Salary</option>
                                    <option value="Bonus">Bonus</option>
                                    <option value="Investment">Investment</option>
                                    <option value="Gift">Gift</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="income-desc" class="form-label">Description</label>
                                <input type="text" class="form-control" id="income-desc" th:field="*{description}" placeholder="Optional">
                            </div>
                            <button type="submit" class="btn btn-success">Add Income</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="text-center my-4">
             <button class="btn btn-lg btn-gold" data-bs-toggle="modal" data-bs-target="#aiSummaryModal" id="ai-summary-btn">âœ¦ AI Summary âœ¦</button>
        </div>
        
        
        <div class="row g-4 mb-5">
            
            <div class="col-md-6">
                <button class="btn btn-gold w-100 mb-2" id="toggle-expenses">Show Expense History</button>
                <div class="card" id="expense-history-card" style="display: none;">
                    <div class="card-header">
                        <h5>Expense History</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                             <button class="btn btn-sm btn-outline-warning expense-filter-btn active" data-filter="all">All</button>
                             <button class="btn btn-sm btn-outline-warning expense-filter-btn" data-filter="today">Today</button>
                             <button class="btn btn-sm btn-outline-warning expense-filter-btn" data-filter="week">This Week</button>
                             <button class="btn btn-sm btn-outline-warning expense-filter-btn" data-filter="last-month">Last Month</button>
                         </div>
                         <table class="table table-sm table-hover">
                            <thead>
                                <tr><th>Date</th><th>Amount</th><th>Category</th><th></th></tr>
                            </thead>
                            <tbody id="expense-history-tbody">
                                <tr th:each="expense : ${expenses}" th:data-date="${expense.expense_date}">
                                    <td th:text="${expense.expense_date}"></td>
                                    <td th:text="'â‚¹' + ${#numbers.formatDecimal(expense.amount, 1, 'COMMA', 2, 'POINT')}"></td>
                                    <td th:text="${expense.category}"></td>
                                    <td><a th:href="@{/delete/{id}(id=${expense.id})}" class="btn btn-xs btn-outline-danger">&times;</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <button class="btn btn-gold w-100 mb-2" id="toggle-incomes">Show Income History</button>
                 <div class="card" id="income-history-card" style="display: none;">
                    <div class="card-header">
                        <h5>Income History</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                             <button class="btn btn-sm btn-outline-warning income-filter-btn active" data-filter="all">All</button>
                             <button class="btn btn-sm btn-outline-warning income-filter-btn" data-filter="today">Today</button>
                             <button class="btn btn-sm btn-outline-warning income-filter-btn" data-filter="week">This Week</button>
                             <button class="btn btn-sm btn-outline-warning income-filter-btn" data-filter="last-month">Last Month</button>
                         </div>
                         <table class="table table-sm table-hover">
                            <thead>
                                <tr><th>Date</th><th>Amount</th><th>Category</th><th></th></tr>
                            </thead>
                            <tbody id="income-history-tbody">
                                <tr th:each="income : ${incomes}" th:data-date="${income.expense_date}">
                                    <td th:text="${income.expense_date}"></td>
                                    <td th:text="'â‚¹' + ${#numbers.formatDecimal(T(java.lang.Math).abs(income.amount), 1, 'COMMA', 2, 'POINT')}"></td>
                                    <td th:text="${income.category}"></td>
                                    <td><a th:href="@{/delete/{id}(id=${income.id})}" class="btn btn-xs btn-outline-danger">&times;</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <div class="modal fade" id="aiSummaryModal" tabindex="-1" aria-labelledby="aiSummaryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aiSummaryModalLabel" style="color: var(--gold-primary);">âœ¦ Your AI Financial Summary âœ¦</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="summary-content" style="min-height: 200px; white-space: pre-wrap;">
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            const toggleExpensesBtn = document.getElementById('toggle-expenses');
            const expenseCard = document.getElementById('expense-history-card');
            toggleExpensesBtn.addEventListener('click', () => {
                const isHidden = expenseCard.style.display === 'none';
                expenseCard.style.display = isHidden ? 'block' : 'none';
                toggleExpensesBtn.textContent = isHidden ? 'Hide Expense History' : 'Show Expense History';
            });

            const toggleIncomesBtn = document.getElementById('toggle-incomes');
            const incomeCard = document.getElementById('income-history-card');
            toggleIncomesBtn.addEventListener('click', () => {
                const isHidden = incomeCard.style.display === 'none';
                incomeCard.style.display = isHidden ? 'block' : 'none';
                toggleIncomesBtn.textContent = isHidden ? 'Hide Income History' : 'Show Income History';
            });

            
            function filterTable(tbodyId, filter) {
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                rows.forEach(row => {
                    const dateStr = row.dataset.date;
                    if (!dateStr) return;
                    
                    const rowDate = new Date(dateStr + 'T00:00:00');
                    let show = false;

                    if (filter === 'all') {
                        show = true;
                    } else if (filter === 'today') {
                        show = rowDate.getTime() === today.getTime();
                    } else if (filter === 'week') {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        show = rowDate >= weekStart && rowDate <= today;
                    } else if (filter === 'last-month') {
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthYear = lastMonth.getFullYear();
                        const lastMonthMonth = lastMonth.getMonth();
                        show = rowDate.getFullYear() === lastMonthYear && rowDate.getMonth() === lastMonthMonth;
                    }

                    row.style.display = show ? '' : 'none';
                });
            }

            document.querySelectorAll('.expense-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.expense-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    filterTable('expense-history-tbody', e.target.dataset.filter);
                });
            });

            document.querySelectorAll('.income-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.income-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    filterTable('income-history-tbody', e.target.dataset.filter);
                });
            });

            
            const summaryBtn = document.getElementById('ai-summary-btn');
            const summaryContent = document.getElementById('summary-content');

            summaryBtn.addEventListener('click', async () => {
                summaryContent.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <strong class="ms-3">Generating your summary...</strong>
                    </div>`;

                try {
                    
                    const response = await fetch('/api/generate-summary');
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                 
                    const aiResult = await response.json();

                    
                    if (aiResult.candidates && aiResult.candidates[0].content.parts[0].text) {
                        const summaryText = aiResult.candidates[0].content.parts[0].text;
                        summaryContent.innerText = summaryText;
                    } else {
                        throw new Error('Unexpected AI response format.');
                    }

                } catch (error) {
                    console.error("AI Summary Error:", error);
                    summaryContent.innerText = "Sorry, an error occurred while generating the summary. Please check the console for details and try again later.";
                }
            });
        });
    </script>
</body>
</html>

